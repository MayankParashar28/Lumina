<nav class="floating-nav">
  <% if (locals.announcement) { %>
    <div class="announcement-bar alert-<%= locals.announcement.type %>">
      <div class="container text-center">
        <i class="bi bi-megaphone-fill me-2"></i>
        <span>
          <%= locals.announcement.message %>
        </span>
      </div>
    </div>
    <% } %>
      <div class="nav-content">
        <!-- Mobile Toggle -->
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
          <i class="bi bi-list"></i>
        </button>

        <!-- Brand -->
        <a class="nav-brand" href="/">
          <span class="brand-name">Lumina</span>
        </a>

        <!-- Center Links -->
        <ul class="nav-links">
          <li>
            <a href="/"
              class="nav-link-custom <%= (locals.path === '/' || locals.path.startsWith('/blog')) ? 'active' : '' %>">
              Blogs
            </a>
          </li>
          <li>
            <a href="/about" class="nav-link-custom <%= locals.path === '/about' ? 'active' : '' %>">
              Mission
            </a>
          </li>
        </ul>

        <!-- Right Actions -->
        <div class="nav-actions">
          <!-- Search (Icon Only Trigger) -->
          <div class="search-trigger">
            <button id="searchToggle" class="icon-btn">
              <i class="bi bi-search"></i>
            </button>
            <form class="floating-search" method="GET" action="/" id="searchForm">
              <input id="searchInput" type="text" name="searchQuery" placeholder="Search..." autocomplete="off">
            </form>
          </div>

          <% if (locals.user) { %>
            <a href="/blog/add-new" class="icon-btn" title="Write">
              <i class="bi bi-plus-lg"></i>
            </a>

            <a href="/notifications" class="icon-btn position-relative">
              <i class="bi bi-bell"></i>
              <span id="notification-count" class="notification-dot" style="display: none;"></span>
            </a>

            <!-- Profile Dropdown (Simplified) -->
            <div class="profile-dropdown">
              <button class="profile-trigger">
                <i class="bi bi-person-circle"></i>
              </button>
              <div class="dropdown-menu-custom">
                <div class="dropdown-header">
                  <%= locals.user.fullName || locals.user.email %>
                </div>
                <% if (locals.user.role==='ADMIN' ) { %>
                  <a href="/admin" class="dropdown-item fw-bold text-primary">Admin Panel</a>
                  <% } %>
                    <a href="/user/profile" class="dropdown-item">Profile</a>
                    <a href="/user/logout" class="dropdown-item danger">Log Out</a>
              </div>
            </div>

            <% } else { %>
              <div class="auth-buttons">
                <a href="/user/signin" class="nav-link-custom">Sign In</a>
                <a href="/user/signup" class="btn-pill">Get Started</a>
              </div>
              <% } %>
        </div>
      </div> <!-- Closing nav-content -->
</nav>

<script>
  function toggleMobileMenu() {
    const nav = document.querySelector('.floating-nav');
    const btnIcon = document.querySelector('.mobile-menu-btn i');
    nav.classList.toggle('nav-open');

    if (nav.classList.contains('nav-open')) {
      btnIcon.classList.replace('bi-list', 'bi-x-lg');
      document.body.style.overflow = 'hidden'; // Prevent scroll
    } else {
      btnIcon.classList.replace('bi-x-lg', 'bi-list');
      document.body.style.overflow = '';
    }
  }
</script>

<!-- Global Flash Messages (Toasts) -->
<% if (locals.success_msg && locals.success_msg.length> 0 || locals.error_msg && locals.error_msg.length > 0) { %>
  <div id="flash-toast-container">
    <% if (locals.success_msg && locals.success_msg.length> 0) { %>
      <div class="alert alert-success alert-dismissible fade show toast-animate" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <%= locals.success_msg %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      <% } %>

        <% if ((locals.error_msg && locals.error_msg.length> 0) || (locals.error && locals.error.length > 0)) { %>
          <div class="alert alert-danger alert-dismissible fade show toast-animate" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <%= (locals.error_msg && locals.error_msg.length> 0) ? locals.error_msg : locals.error %>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
          <% } %>
  </div>
  <% } %>

    <!-- Bootstrap Icons + Bundle -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      crossorigin="anonymous"></script>


    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      // AI Access Button
      document.getElementById("ai-access-btn")?.addEventListener("click", async (e) => {
        e.preventDefault();
        try {
          const res = await fetch("/subscription/create-checkout-session", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            }
          });
          const data = await res.json();
          if (data.url) window.location.href = data.url;
          else alert("Error: Unable to process payment.");
        } catch (err) {
          console.error("Payment Error:", err);
          alert("Something went wrong. Try again later.");
        }
      });

      // Notification Count
      async function updateNotificationCount() {
        try {
          const res = await fetch("/notifications/unread-count");
          const data = await res.json();
          const badge = document.getElementById("notification-count");
          if (badge && data.count > 0) {
            badge.style.display = "block";
          } else if (badge) {
            badge.style.display = "none";
          }
        } catch (err) {
          console.error("Failed to load notification count", err);
        }
      }
      document.addEventListener("DOMContentLoaded", updateNotificationCount);
      setInterval(updateNotificationCount, 10000);

      // Search Toggle
      const searchToggle = document.getElementById('searchToggle');
      const searchForm = document.getElementById('searchForm');
      const searchInput = document.getElementById('searchInput');

      searchToggle?.addEventListener('click', (e) => {
        e.stopPropagation();
        searchForm.classList.toggle('active');
        if (searchForm.classList.contains('active')) {
          searchInput.focus();
        }
      });

      document.addEventListener('click', (e) => {
        if (searchForm && !searchForm.contains(e.target) && !searchToggle.contains(e.target)) {
          searchForm.classList.remove('active');
        }
      });

      // Profile Dropdown Toggle
      const profileTrigger = document.querySelector('.profile-trigger');
      const dropdownMenu = document.querySelector('.dropdown-menu-custom');

      profileTrigger?.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle('active');
      });

      document.addEventListener('click', (e) => {
        if (dropdownMenu && !dropdownMenu.contains(e.target)) {
          dropdownMenu.classList.remove('active');
        }
      });

      // Foggy Toast Auto-Dismiss
      document.addEventListener("DOMContentLoaded", () => {
        const toasts = document.querySelectorAll(".toast-animate");
        toasts.forEach(toast => {
          // Wait 3 seconds, then turn to fog
          setTimeout(() => {
            toast.classList.add("fog-vanish");
            // Remove from DOM after animation finishes (1.5s)
            setTimeout(() => {
              toast.remove();
            }, 1500);
          }, 3000);
        });
      });

      // ðŸ”„ Real-Time Notifications
      <% if (locals.user) { %>
        const socket = io();
        socket.emit("register", "<%= locals.user._id %>");

        socket.on("new_notification", (data) => {
          // 1. Show Toast
          const container = document.getElementById("flash-toast-container") || createToastContainer();
          const toast = document.createElement("div");
          toast.className = "alert alert-info alert-dismissible fade show toast-animate";
          toast.role = "alert";
          toast.innerHTML = `
             <i class="bi bi-bell-fill me-2"></i> ${data.message}
             <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
           `;
          container.appendChild(toast);

          // Auto dismiss
          setTimeout(() => {
            toast.classList.add("fog-vanish");
            setTimeout(() => toast.remove(), 1500);
          }, 4000);

          // 2. Update Badge
          const badge = document.getElementById("notification-count");
          if (badge) {
            const current = parseInt(badge.innerText) || 0;
            badge.innerText = current + 1;
            badge.style.display = "block";
            badge.classList.add("animate-bounce"); // Optional: bounce animation
            setTimeout(() => badge.classList.remove("animate-bounce"), 500);
          }
        });

        function createToastContainer() {
          const div = document.createElement("div");
          div.id = "flash-toast-container";
          document.body.appendChild(div);
          return div;
        }
      <% } %>
    </script>