<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('./partials/header') %>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <link rel="stylesheet" href="/css/notifications.css">
</head>

<body>
    <%- include('./partials/nav', { searchQuery: searchQuery || '' }) %>


        <div class="container">
            <% if (notifications.length===0) { %>
                <p class="no-notifications">No new notifications.</p>
                <% } else { %>
                    <ul id="notifications">
                        <% notifications.forEach(notification=> { %>
                            <% let link='#' ; if (notification.targetUrl) link=notification.targetUrl; else if
                                (notification.type==='follow' ) link=`/user/profile/${notification.senderId._id}`; else
                                if (notification.blogId) link=`/blog/${notification.blogId}`; %>
                                <li id="notif-<%= notification._id %>"
                                    class="<%= notification.read ? 'read' : 'unread' %> notification-item"
                                    onclick="handleNotificationClick(event, '<%= notification._id %>', '<%= link %>')"
                                    style="cursor: pointer;">

                                    <div class="notif-message">
                                        <img src="<%= (notification.senderId && notification.senderId.profilePic) ? notification.senderId.profilePic : '/images/default-user.png' %>"
                                            alt="Profile" width="40" height="40" class="rounded-circle">

                                        <span class="message-content">
                                            <strong class="message-text">
                                                <%= notification.message %>
                                            </strong>
                                        </span>
                                    </div>
                                    <span class="time-ago" data-time="<%= notification.createdAt %>"></span>

                                    <!-- Restore Mark as Read Button -->
                                    <% if (!notification.read) { %>
                                        <button class="mark-read-btn"
                                            onclick="handleNotificationClick(event, '<%= notification._id %>', '#', true)">
                                            Mark as Read
                                        </button>
                                        <% } %>
                                </li>
                                <% }) %>
                    </ul>
                    <% } %>
        </div>

        <%- include('./partials/footer') %>

            <!-- Theme Toggle Button -->


            <script> // Notification handling
                // Function to mark notification as read
                // Function to mark notification as read AND navigate
                async function handleNotificationClick(event, notificationId, targetUrl, skipNavigation = false) {
                    // Stop event bubbling so row click doesn't trigger if button clicked
                    if (event) event.stopPropagation();

                    // 1. Optimistic UI update
                    const notifElement = document.getElementById(`notif-${notificationId}`);
                    if (notifElement) {
                        notifElement.classList.add("read");
                        notifElement.classList.remove("unread");

                        // Hide the button immediately if clicked
                        const btn = notifElement.querySelector('.mark-read-btn');
                        if (btn) btn.style.display = 'none';
                    }

                    // 2. Fire request in background
                    fetch(`/notifications/mark-read/${notificationId}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        keepalive: true
                    }).catch(err => console.error("Mark read failed", err));

                    // 3. Navigate to the content (unless skipped)
                    if (!skipNavigation && targetUrl && targetUrl !== '#' && targetUrl !== 'undefined') {
                        window.location.href = targetUrl;
                    }
                }

                /* 
                   Legacy Mark as Read - Removed since whole item is clickable now
                   async function markAsRead(notificationId) { ... }
                */

                function timeAgo(dateString) {
                    const date = new Date(dateString);
                    const now = new Date();
                    const seconds = Math.floor((now - date) / 1000);

                    let interval = Math.floor(seconds / 31536000);
                    if (interval === 1) return "1 year ago";
                    if (interval > 1) return interval + " years ago";

                    interval = Math.floor(seconds / 2592000);
                    if (interval === 1) return "1 month ago";
                    if (interval > 1) return interval + " months ago";

                    interval = Math.floor(seconds / 86400);
                    if (interval === 1) return "1 day ago";
                    if (interval > 1) return interval + " days ago";

                    interval = Math.floor(seconds / 3600);
                    if (interval === 1) return "1 hour ago";
                    if (interval > 1) return interval + " hours ago";

                    interval = Math.floor(seconds / 60);
                    if (interval === 1) return "1 min ago";
                    if (interval > 1) return interval + " mins ago";

                    return "just now";
                }

                // Update timestamps on load
                document.addEventListener("DOMContentLoaded", () => {
                    document.querySelectorAll(".time-ago").forEach(el => {
                        const timestamp = el.getAttribute("data-time");
                        el.textContent = timeAgo(timestamp);
                    });

                    // Existing mark as read logic
                    document.querySelectorAll(".mark-read-btn").forEach(button => {
                        button.addEventListener("click", function () {
                            const notificationId = this.getAttribute("data-id");
                            markAsRead(notificationId);
                        });
                    });
                });
            </script>
</body>

</html>