<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('./partials/header') %>
</head>
<link rel="stylesheet" href="/css/blog.css?v=21">
<!-- Quill Theme for matching styles -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<body>
    <%- include('./partials/nav', { searchQuery: searchQuery || '' }) %>

        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>



        <!-- Professional Blog Content -->
        <article class="blog-container">
            <!-- Header -->
            <header class="blog-header">
                <div class="blog-tags">
                    <% if (blog.category) { %>
                        <span class="category-pill">
                            <%= blog.category %>
                        </span>
                        <% } %>
                </div>
                <h1 class="blog-title">
                    <%= blog.title %>
                </h1>
                <div class="blog-meta">
                    <% if (blog.createdBy) { %>
                        <a href="/user/profile/<%= blog.createdBy._id %>" class="author-info"
                            style="text-decoration: none; color: inherit;">
                            <img src="<%= optimizeImage(createdByProfilePic, { width: 100, height: 100 }) %>"
                                alt="<%= createdByName %>" class="author-avatar-sm">
                            <span class="author-name">
                                <%= createdByName %>
                            </span>
                        </a>
                        <% if (user && blog.createdBy && String(user._id) !==String(blog.createdBy._id)) { %>
                            <form method="POST" action="/user/follow/<%= blog.createdBy._id %>"
                                style="display: inline;">
                                <button
                                    class="btn-follow <%= (user.following && user.following.includes(blog.createdBy.id)) ? 'followed' : '' %>"
                                    style="padding: 0.2rem 0.8rem; font-size: 0.75rem; min-width: auto; margin-left: 0.5rem;">
                                    <%= (user.following && user.following.includes(blog.createdBy.id)) ? 'Following'
                                        : 'Follow' %>
                                </button>
                            </form>
                            <% } %>
                                <% } else { %>
                                    <div class="author-info">
                                        <img src="<%= optimizeImage(createdByProfilePic, { width: 100, height: 100 }) %>"
                                            alt="<%= createdByName %>" class="author-avatar-sm">
                                        <span class="author-name">
                                            <%= createdByName %>
                                        </span>
                                    </div>
                                    <% } %>
                                        <span class="meta-divider">Â·</span>
                                        <span class="publish-date">
                                            <%= formattedDate %>
                                        </span>
                                        <span class="meta-divider">Â·</span>
                                        <span class="view-count">
                                            <%= blog.views %> Views
                                        </span>
                </div>
            </header>

            <!-- Hero Image -->
            <% if (blog.coverImageURL) { %>
                <div class="hero-image-container">
                    <img src="<%= optimizeImage(blog.coverImageURL, { width: 1200 }) %>" alt="<%= blog.title %>"
                        class="blog-hero-image">
                </div>
                <% } %>
                    <div class="content-wrapper">


                        <!-- Editorial Content -->
                        <div class="blog-body editorial-typography ql-snow" id="blog-content-wrapper">
                            <div class="ql-editor" id="blog-content">
                                <!-- Content injected via JS -->
                            </div>

                            <!-- Raw content hidden for JS to parse -->
                            <div id="raw-content" style="display:none;">
                                <%= blog.body %>
                            </div>
                        </div>
                        <!-- Vertical Action Bar (Right-aligned at end of post) -->
                        <div class="article-actions-bar-vertical mobile-action-bar">
                            <div class="action-item">
                                <button class="action-icon-btn like-btn-trigger" data-blog-id="<%= blog._id %>"
                                    title="Like">
                                    <i
                                        class="<%= user && blog.likedBy.includes(user._id.toString()) ? 'fas text-red' : 'far' %> fa-heart like-icon-target"></i>
                                    <span class="action-label like-count-target">
                                        <%= blog.likes || 0 %>
                                    </span>
                                </button>
                            </div>
                            <div class="action-item">
                                <button class="action-icon-btn" title="Comment"
                                    onclick="document.getElementById('comments').scrollIntoView({ behavior: 'smooth' });">
                                    <i class="far fa-comment"></i>
                                    <!-- <span class="action-label">
                                    <%= comments.length %>
                                </span> -->
                                </button>
                            </div>
                            <% if (user) { %>
                                <div class="action-item">
                                    <button class="action-icon-btn bookmark-btn-trigger" data-blog-id="<%= blog._id %>"
                                        title="Bookmark">
                                        <i
                                            class="<%= isBookmarked ? 'fas' : 'far' %> fa-bookmark bookmark-icon-target"></i>
                                    </button>
                                </div>
                                <% } %>
                                    <div class="action-item">
                                        <button class="action-icon-btn share-btn-trigger" title="Share Story">
                                            <i class="fas fa-share-alt"></i>
                                        </button>
                                    </div>
                                    <% if (user && blog.createdBy && String(user._id)===String(blog.createdBy.id)) { %>
                                        <div class="action-item edit-item">
                                            <a href="/blog/edit/<%= blog._id %>" class="action-icon-btn"
                                                title="Edit Blog">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                        </div>
                                        <% } %>
                        </div>
                    </div>

                    <!-- Sanitizer -->
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
                    <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            const rawContent = document.getElementById("raw-content").textContent; // Get escaped HTML source
                            const blogBody = document.getElementById("blog-content");

                            // Sanitize the HTML directly (Quill produces HTML)
                            const cleanHTML = DOMPurify.sanitize(rawContent);
                            blogBody.innerHTML = cleanHTML;
                        });
                    </script>

        </article>

        <!-- Comments -->
        <div class="comments-section" id="comments">
            <h3 class="input-label" style="margin-bottom: 1.5rem;">Discussion (<%= comments.length %>)</h3>

            <% if (user) { %>
                <!-- AI Comment Suggestions -->
                <div id="ai-suggestions-container" class="ai-suggestions-wrapper">
                    <div class="ai-chip-label">âœ¨ AI Suggestions</div>
                    <div id="ai-suggestions-list" class="ai-suggestions-list">
                        <!-- Skeleton Loading Chips -->
                        <div class="ai-suggestion-chip skeleton"></div>
                        <div class="ai-suggestion-chip skeleton" style="width: 80px;"></div>
                        <div class="ai-suggestion-chip skeleton" style="width: 100px;"></div>
                    </div>
                </div>

                <script>
                    document.addEventListener("DOMContentLoaded", () => {
                        const blogId = "<%= blog._id %>";
                        const suggestionsContainer = document.getElementById("ai-suggestions-container");
                        const suggestionsList = document.getElementById("ai-suggestions-list");
                        const commentBox = document.querySelector(".comment-textarea");

                        if (!suggestionsContainer || !suggestionsList || !commentBox) return;

                        const defaultSuggestions = ["Great read! ðŸ‘", "Thanks for sharing.", "Interesting perspective."];

                        const renderChips = (texts) => {
                            suggestionsList.innerHTML = ""; // Clear skeletons
                            texts.forEach(text => {
                                const chip = document.createElement("button");
                                chip.className = "ai-suggestion-chip";
                                chip.innerText = text;
                                chip.onclick = (e) => {
                                    e.preventDefault();
                                    commentBox.value = text;
                                    commentBox.focus();
                                };
                                suggestionsList.appendChild(chip);
                            });
                        };

                        // Timeout Promise
                        const timeout = new Promise((resolve) => {
                            setTimeout(() => resolve({ suggestions: defaultSuggestions }), 3000); // 3s Timeout
                        });

                        // Fetch Request
                        const fetchRequest = fetch('/ai/generate-comment-suggestions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ blogId }),
                            credentials: 'include'
                        }).then(res => res.json());

                        // Race: AI vs Timeout
                        Promise.race([fetchRequest, timeout])
                            .then(data => {
                                if (data.suggestions && data.suggestions.length > 0) {
                                    renderChips(data.suggestions);
                                } else {
                                    renderChips(defaultSuggestions);
                                }
                            })
                            .catch(err => {
                                console.error("AI Error, using defaults", err);
                                renderChips(defaultSuggestions);
                            });
                    });
                </script>

                <form method="post" action="/blog/comment/<%= blog._id %>" class="comment-form">
                    <div class="comment-input-wrapper">
                        <img src="<%= user.profilePic %>" class="comment-avatar">
                        <div class="input-box-wrapper">
                            <textarea name="content" class="comment-textarea" placeholder="Add to the discussion..."
                                required rows="1"
                                oninput="this.style.height = ''; this.style.height = (this.scrollHeight) + 'px'"></textarea>
                            <div class="form-actions">
                                <button type="submit" class="btn-comment">Post Comment</button>
                            </div>
                        </div>
                    </div>
                </form>
                <% } else { %>
                    <div class="login-prompt">
                        <p>Please <a href="/user/signin">sign in</a> to join the discussion.</p>
                    </div>
                    <% } %>

                        <div class="comments-list">
                            <% if (comments.length> 0) { %>
                                <% comments.forEach(comment=> { %>
                                    <%- include('./partials/comment-thread', { comment: comment, user: user, blog: blog,
                                        moment: moment }) %>
                                        <% }); %>
                                            <% } else { %>
                                                <div class="no-comments">
                                                    <p>No comments yet. Be the first to share your thoughts!</p>
                                                </div>
                                                <% } %>
                        </div>
        </div>

        <!-- Recommended Stories Section -->
        <section class="recommendation-section"
            style="max-width: 900px; margin: 4rem auto; padding: 0 1rem; width: 100%; box-sizing: border-box;">
            <h3
                style="font-size: 1.1rem; font-weight: 700; margin-bottom: 2rem; text-transform: uppercase; letter-spacing: 0.05em; color: #555;">
                Recommended For You</h3>
            <div id="recommendation-grid"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; width: 100%;">
                <!-- Content injected via JS -->
                <p style="color: #999; font-style: italic;">Finding best matches...</p>
            </div>
        </section>

        <script>
            // Fetch Recommendations
            document.addEventListener("DOMContentLoaded", async () => {
                const blogId = "<%= blog._id %>";
                const grid = document.getElementById("recommendation-grid");

                try {
                    const res = await fetch(`/blog/recommendations/${blogId}`);
                    const data = await res.json();

                    if (data.blogs && data.blogs.length > 0) {
                        grid.innerHTML = data.blogs.map(blog => `
                            <a href="/blog/${blog._id}" style="text-decoration: none; color: inherit; display: flex; flex-direction: column; gap: 0.8rem;">
                                <div style="aspect-ratio: 16/9; border-radius: 8px; overflow: hidden; background: #eee;">
                                    <img src="${blog.coverImageURL || '/images/default-cover.jpg'}" style="width: 100%; height: 100%; object-fit: cover;" alt="${blog.title}">
                                </div>
                                <div>
                                    <h4 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem; line-height: 1.3;">${blog.title}</h4>
                                    <span style="font-size: 0.75rem; color: #888; text-transform: uppercase;">Based on similar content</span>
                                </div>
                            </a>
                        `).join("");
                    } else {
                        grid.innerHTML = '<p style="color: #999;">No similar stories found.</p>';
                    }
                } catch (err) {
                    console.error("Failed to load recommendations", err);
                    grid.innerHTML = "";
                }
            });
        </script>


        <script>
            // Progress Bar Script
            window.onscroll = function () { myFunction() };
            function myFunction() {
                var winScroll = document.body.scrollTop || document.documentElement.scrollTop;
                var height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
                var scrolled = (winScroll / height) * 100;
                document.getElementById("progress-bar").style.width = scrolled + "%";
            }

            // Bookmark Logic (Class-based for Mobile + Desktop)
            document.querySelectorAll('.bookmark-btn-trigger').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const blogId = btn.dataset.blogId;
                    try {
                        const response = await fetch(`/blog/bookmark/${blogId}`, { method: 'POST' });
                        const data = await response.json();

                        if (data.success) {
                            // Update ALL bookmark icons on page
                            document.querySelectorAll('.bookmark-icon-target').forEach(icon => {
                                if (data.bookmarked) {
                                    icon.classList.remove('far');
                                    icon.classList.add('fas');
                                } else {
                                    icon.classList.remove('fas');
                                    icon.classList.add('far');
                                }
                            });
                        }
                    } catch (err) {
                        console.error('Error bookmarking blog:', err);
                    }
                });
            });

            // Like Button Logic (Class-based)
            document.querySelectorAll('.like-btn-trigger').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const blogId = btn.dataset.blogId;
                    try {
                        const response = await fetch(`/blog/like/${blogId}`, { method: 'POST' });
                        const data = await response.json();

                        if (data.likes !== undefined) {
                            // Update ALL like counts
                            document.querySelectorAll('.like-count-target').forEach(span => {
                                span.innerText = data.likes;
                            });

                            // Update ALL like icons
                            document.querySelectorAll('.like-icon-target').forEach(icon => {
                                icon.classList.toggle('fas');
                                icon.classList.toggle('far');
                                icon.classList.toggle('text-red');
                                icon.classList.add('animate-like');
                                setTimeout(() => icon.classList.remove('animate-like'), 450);
                            });
                        }
                    } catch (err) {
                        console.error('Error liking blog:', err);
                    }
                });
            });
        </script>
        <script>
            // Comment Scroll (Already handled inline for mobile, keeping for desktop ID if exists)
            const commentBtn = document.getElementById('comment-btn');
            if (commentBtn) {
                commentBtn.addEventListener('click', () => {
                    const commentsSection = document.querySelector('.comments-section');
                    if (commentsSection) {
                        commentsSection.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            }

            // Share Logic (Class-based)
            document.querySelectorAll('.share-btn-trigger').forEach(btn => {
                btn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(window.location.href);
                        alert('Link copied to clipboard!');
                    } catch (err) {
                        console.error('Failed to copy: ', err);
                    }
                });
            });

            // ðŸ˜ƒ Emoji Picker Logic
            function toggleReactionPicker(commentId, btn) {
                // Close others
                document.querySelectorAll('.reaction-picker').forEach(p => {
                    if (p.id !== `reaction-picker-${commentId}`) p.classList.add('hidden');
                });

                const picker = document.getElementById(`reaction-picker-${commentId}`);
                if (picker) {
                    picker.classList.toggle('hidden');
                }

                // Stop propagation so document click doesn't close immediately
                if (event) event.stopPropagation();
            }

            // Close pickers on outside click
            document.addEventListener('click', () => {
                document.querySelectorAll('.reaction-picker').forEach(p => p.classList.add('hidden'));
            });

            // âš¡ Emoji Reaction Logic (Updated)
            async function toggleReaction(commentId, emoji, btn) {
                try {
                    const res = await fetch(`/blog/comment/${commentId}/react`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ emoji })
                    });

                    const data = await res.json();
                    if (data.success) {
                        // ðŸŸ¢ Dynamic DOM Update (No Reload)
                        const commentCard = document.getElementById(`comment-${commentId}`);

                        // 1. Update Trigger Button
                        const triggerBtn = commentCard.querySelector('.btn-reaction-trigger');
                        if (triggerBtn) {
                            // Are we reacting or un-reacting?
                            // We can guess by checking if we clicked the same emoji that was active, 
                            // but safer to rely on returned data if possible. 
                            // Since we don't have "myReaction" in response yet, we can infer:
                            // If user clicked emoji X and it was NOT active, it is now active.
                            // Actually, let's assume successful toggle means state flipped.

                            // Better approach: server response could return `myReaction`.
                            // For now, let's just use the clicked `emoji` as active if it wasn't before?
                            // Or simpler: Just update the visual state based on what we clicked.

                            // Let's implement a visual toggle for immediate feedback
                            // But accurate state requires server data. Let's assume we toggle it ON
                            // unless we clicked the active one.

                            // Actually, `data.reactionCounts` is returned.
                            // The `toggleReaction` endpoint logic is: Toggle.

                            // Let's update the Trigger Icon based on specific logic:
                            // If `btn` (the option clicked) was already `.active`, we unreacted -> Show Empty Heart.
                            // If it wasn't active, we reacted -> Show Emoji.

                            const wasActive = btn.classList.contains('active');
                            if (wasActive) {
                                // Unreacted
                                triggerBtn.innerHTML = '<i class="far fa-heart"></i>';
                                btn.classList.remove('active');
                            } else {
                                // Reacted
                                triggerBtn.innerHTML = `<span style="font-style: normal; font-size: 1.1rem;">${emoji}</span>`;
                                // Clear other actives
                                commentCard.querySelectorAll('.reaction-option').forEach(o => o.classList.remove('active'));
                                btn.classList.add('active');
                            }
                        }

                        // 2. Update Counts Chips at Bottom
                        const actionCmdDiv = commentCard.querySelector('.reaction-bar'); // Actually sits in .comment-actions
                        let existingReactionsDiv = commentCard.querySelector('.existing-reactions');

                        if (!existingReactionsDiv) {
                            // Create if doesn't exist (and we have counts)
                            existingReactionsDiv = document.createElement('div');
                            existingReactionsDiv.className = 'existing-reactions';
                            // Append to .reaction-bar (which is correctly located at bottom)
                            actionCmdDiv.appendChild(existingReactionsDiv);
                        }

                        // Re-render chips
                        existingReactionsDiv.innerHTML = '';
                        const counts = data.reactionCounts || {};
                        Object.entries(counts).forEach(([em, count]) => {
                            if (count > 0) {
                                const chip = document.createElement('span');
                                chip.className = 'reaction-count-chip';
                                chip.innerHTML = `${em} <span class="count-num">${count}</span>`;
                                chip.onclick = function () { toggleReaction(commentId, em, chip); };
                                existingReactionsDiv.appendChild(chip);
                            }
                        });

                    } else if (data.message === "Login required") {
                        window.location.href = "/user/signin";
                    }
                } catch (err) {
                    console.error("Reaction failed", err);
                }
            }

            // ðŸ’¬ Toggle Reply Form
            function toggleReplyForm(commentId) {
                const form = document.getElementById(`reply-form-${commentId}`);
                if (form) {
                    form.classList.toggle('hidden');
                    if (!form.classList.contains('hidden')) {
                        const textarea = form.querySelector('textarea');
                        if (textarea) textarea.focus();
                    }
                }
            }

            // ðŸ“Œ Toggle Pin
            async function togglePin(commentId, btn) {
                try {
                    const response = await fetch(`/blog/comment/${commentId}/pin`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" }
                    });
                    const data = await response.json();
                    if (data.success) {
                        window.location.reload();
                    }
                } catch (err) {
                    console.error("Pin failed", err);
                }
            }

            // ðŸš€ AJAX Reply
            async function handleReplySubmit(e, commentId) {
                e.preventDefault();
                const form = e.target;
                const textarea = form.querySelector('textarea');
                const content = textarea.value;
                const btn = form.querySelector('button');

                const originalText = btn.innerText;
                btn.disabled = true;
                btn.innerText = "Posting...";

                try {
                    const response = await fetch(`/blog/comment/${commentId}/reply`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Accept": "application/json"
                        },
                        body: JSON.stringify({ content })
                    });

                    const data = await response.json();
                    if (data.success) {
                        const reply = data.reply;
                        const commentCard = document.getElementById(`comment-${commentId}`);

                        let nestedContainer = commentCard.querySelector('.nested-replies');
                        if (!nestedContainer) {
                            nestedContainer = document.createElement('div');
                            nestedContainer.className = 'nested-replies';
                            // Insert after form (which is inside .comment-actions sibling usually? No, let's verify structure again)
                            // In view: .comment-actions -> form -> .nested-replies
                            // So insert after the form.
                            form.insertAdjacentElement('afterend', nestedContainer);
                        }

                        const replyHtml = data.html; // Use Server-Rendered HTML (Complete with Buttons)

                        // Fallback/Safety: If existing dummy ID exists, remove it (highly unlikely with this flow)
                        const existingInfo = document.getElementById(`comment-${data.reply._id}`);
                        if (existingInfo) existingInfo.remove();

                        nestedContainer.insertAdjacentHTML('beforeend', replyHtml);

                        // Add animation class manually since it's injected
                        const newCard = nestedContainer.lastElementChild;
                        if (newCard) {
                            newCard.style.animation = "fadeIn 0.5s ease";
                        }

                        textarea.value = "";
                        form.classList.add("hidden");

                    } else {
                        alert("Failed to reply: " + (data.error || "Unknown error"));
                    }
                } catch (err) {
                    console.error(err);
                    alert("Error replying");
                } finally {
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
                return false;
            }
        </script>
        <%- include('./partials/footer') %>
            <!-- âš¡ Socket.io Real-time Comments -->
            <script src="/socket.io/socket.io.js"></script>
            <script>
                (() => {
                    const socket = io();
                    const blogId = "<%= blog._id %>";

                    // 1. Join Blog Room
                    socket.emit("join_blog", blogId);

                    // 2. Listen for New Comments
                    socket.on("new_comment", (data) => {
                        const { html, parentId, commentId } = data;

                        // Prevent duplicate insertion (in case user gets it via AJAX response too)
                        if (document.getElementById(`comment-${commentId}`)) return;

                        const tempDiv = document.createElement("div");
                        tempDiv.innerHTML = html;
                        const newCommentNode = tempDiv.firstElementChild;

                        // Add fade-in animation class
                        newCommentNode.style.opacity = "0";
                        newCommentNode.style.transition = "opacity 0.5s ease, transform 0.5s ease";
                        newCommentNode.style.transform = "translateY(10px)";

                        if (parentId) {
                            // Nested Reply
                            const parentRepliesContainer = document.getElementById(`replies-${parentId}`);
                            if (parentRepliesContainer) {
                                parentRepliesContainer.appendChild(newCommentNode);
                            }
                        } else {
                            // Root Comment
                            const commentsList = document.querySelector(".comments-list");

                            // Remove "No comments" placeholder if exists
                            const noCommentsMsg = commentsList.querySelector(".no-comments");
                            if (noCommentsMsg) noCommentsMsg.remove();

                            // Append to top or bottom? Usually bottom for threaded, or top depending on sort. 
                            // Our partial uses Flex column, append is standard.
                            commentsList.prepend(newCommentNode); // Newest at top for roots is often preferred, but logic in backend sort was different.
                            // Let's stick to append to match server-side loop order if existing are author-first. 
                            // Actually, standard live feed usually prepends or appends. 
                            // Backend logic: Author > Pinned > Newest. 
                            // If we append, it goes to bottom. If we prepend, top. 
                            // Let's Prepend to make it visible immediately.
                            // However, backend sort put new ones lower down unless pinned.
                            // Let's Append for now to maintain conversation flow, or better, insert after pinned ones? 
                            // Simplest UX: Prepend (show new stuff).

                            // Correction: The backend sorts roots by Author Priority. 
                            // Dynamic insertion is tricky to match strict sort. 
                            // Simple approach: Prepend to top of list (User sees it instantly).
                            if (commentsList.firstChild) {
                                commentsList.insertBefore(newCommentNode, commentsList.firstChild);
                            } else {
                                commentsList.appendChild(newCommentNode);
                            }
                        }

                        // Trigger Animation
                        requestAnimationFrame(() => {
                            newCommentNode.style.opacity = "1";
                            newCommentNode.style.transform = "translateY(0)";
                        });
                    });
                })();
            </script>
</body>

</html>